<Page
    x:Class="VoatHub.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:VoatHub"
    xmlns:voatModels="using:VoatHub.Models.Voat.v1"
    xmlns:voatHubModels="using:VoatHub.Models.VoatHub"
    xmlns:helpers="using:VoatHub.Ui.Helpers"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <!--Converter-->
        <helpers:StringToUriConverter x:Key="StringToUriConverter" />
        <helpers:BoolToNegateVisibilityConverter x:Key="BoolToNegateVisibilityConverter" />
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <helpers:TimeAgoConverter x:Key="TimeAgoConverter" />
        <helpers:BoolNegateConverter x:Key="BoolNegateConverter" />
        
        <!--Styles-->
        <Style x:Key="ContentTreeItemStyle" TargetType="ListViewItem">
            <Setter Property="FontFamily" Value="{ThemeResource ContentControlThemeFontFamily}" />
            <Setter Property="FontSize" Value="{ThemeResource ControlContentThemeFontSize}" />
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="TabNavigation" Value="Local"/>
            <Setter Property="IsHoldingEnabled" Value="True"/>
            <Setter Property="Margin" Value="0,0,0,0"/>
            <Setter Property="Padding" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Top"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <ContentPresenter 
                            ContentTransitions="{TemplateBinding ContentTransitions}"
                            HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                            VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"/>
                        
                        <!--ListViewItemPresenter includes clicking animations by default which I don't want.-->
                        <!--These are the default settings. Use as reference.-->
                        <!--<ListViewItemPresenter
                                ContentTransitions="{TemplateBinding ContentTransitions}"
                                Padding="{TemplateBinding Padding}"
                                SelectionCheckMarkVisualEnabled="False"
                                CheckHintBrush="{ThemeResource ListViewItemCheckHintThemeBrush}"
                                CheckSelectingBrush="{ThemeResource ListViewItemCheckSelectingThemeBrush}"
                                CheckBrush="{ThemeResource ListViewItemCheckThemeBrush}"
                                DragBackground="{ThemeResource ListViewItemDragBackgroundThemeBrush}"
                                DragForeground="{ThemeResource ListViewItemDragForegroundThemeBrush}"
                                FocusBorderBrush="{ThemeResource ListViewItemFocusBorderThemeBrush}"
                                PlaceholderBackground="{ThemeResource ListViewItemPlaceholderBackgroundThemeBrush}"
                                PointerOverBackground="{ThemeResource ListViewItemPointerOverBackgroundThemeBrush}"
                                SelectedBorderThickness="{ThemeResource ListViewItemCompactSelectedBorderThemeThickness}"
                                SelectedBackground="{ThemeResource ListViewItemSelectedBackgroundThemeBrush}"
                                SelectedForeground="{ThemeResource ListViewItemSelectedForegroundThemeBrush}"
                                SelectedPointerOverBackground="{ThemeResource ListViewItemSelectedPointerOverBackgroundThemeBrush}"
                                SelectedPointerOverBorderBrush="{ThemeResource ListViewItemSelectedPointerOverBorderThemeBrush}"
                                DisabledOpacity="{ThemeResource ListViewItemDisabledThemeOpacity}"
                                DragOpacity="{ThemeResource ListViewItemDragThemeOpacity}"
                                ReorderHintOffset="{ThemeResource ListViewItemReorderHintThemeOffset}"
                                HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                PointerOverBackgroundMargin="1"
                                ContentMargin="4" />-->
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!--Main templates-->
        <DataTemplate x:Key="SubmissionItemTemplate" x:DataType="voatModels:ApiSubmission">
            <Grid Margin="0,10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Image Margin="5,0">
                    <Image.Source>
                        <BitmapImage UriSource="{x:Bind Thumbnail, Converter={StaticResource StringToUriConverter}, TargetNullValue={x:Null}}" />
                    </Image.Source>
                </Image>

                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="{x:Bind Title}"
                           Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                           Style="{ThemeResource BodyTextBlockStyle}" />

                    <Grid Grid.Row="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Text="{x:Bind UserName}" MaxLines="1"
                           Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                           Style="{ThemeResource BodyTextBlockStyle}" />

                        <TextBlock Text="{x:Bind Date, Converter={StaticResource TimeAgoConverter}}" Grid.Column="1" Grid.Row="1" Margin="12,2,0,0"
                           Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                           Style="{ThemeResource BodyTextBlockStyle}" />
                    </Grid>
                </Grid>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="SubmissionHeaderTemplate" x:DataType="voatModels:ApiSubmission">
            <StackPanel>
                <TextBlock Margin="0,8" Style="{ThemeResource TitleTextBlockStyle}"
                               Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                               FontWeight="Bold"
                               FontSize="{ThemeResource TextStyleExtraLargeFontSize}"
                               HorizontalAlignment="Left" Text="{x:Bind Title}"/>

                <StackPanel Orientation="Horizontal">
                    <TextBlock Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                            <Run FontWeight="Bold">Votes:</Run> <Run Text="{x:Bind TotalVotes}"/> 
                            <Run FontWeight="Bold">User:</Run> <Run Text="{x:Bind UserName}"/>
                            <Run FontWeight="Bold">Date:</Run> <Run Text="{x:Bind Date, Converter={StaticResource TimeAgoConverter}}"/>
                    </TextBlock>
                </StackPanel>
            </StackPanel>
        </DataTemplate>

        <!--Why are CommentSubmission and LinkSubmission separated into two different data template you ask?
        Well, WebView keep giving me exception when trying to bind its source to a null value. All self posts
        does not have an url so seperate DetailContentPresenter into two data templates, one for self and one for
        link posts just to accomdate the stupid WebView-->

        <DataTemplate x:Key="SubmissionViewModelTemplate" x:DataType="voatHubModels:SubmissionViewModel">
            <ScrollViewer HorizontalScrollBarVisibility="Disabled" 
                          VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!--Having the title scroll with rest of the comments looks better.-->
                    <ContentPresenter ContentTemplate="{StaticResource SubmissionHeaderTemplate}" Content="{x:Bind Submission}" />

                    <TextBlock Margin="0,9" HorizontalAlignment="Left" MaxWidth="560"
                               FontSize="{ThemeResource TextStyleLargeFontSize}"
                               Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                               Style="{ThemeResource SubtitleTextBlockStyle}" Text="{x:Bind Submission.Content}" />

                    <ProgressRing Margin="0,50" Width="50" Height="50"
                                  Visibility="{x:Bind LoadingComments, Converter={StaticResource BoolToVisibilityConverter}}" 
                                  IsActive="{x:Bind LoadingComments}"/>

                    <ListView SelectionMode="None"
                              IsItemClickEnabled="False"
                              ItemContainerStyle="{StaticResource ContentTreeItemStyle}"
                              ItemTemplate="{StaticResource CommentTreeTemplate}"
                              ItemsSource="{x:Bind CommentTree}" />
                </StackPanel>
            </ScrollViewer>
        </DataTemplate>

        <DataTemplate x:Key="CommentTreeTemplate" x:DataType="voatHubModels:CommentTree">
            <StackPanel Padding="10,5,0,5">
                <StackPanel Orientation="Vertical"
                                Padding="10,0,0,0"
                                BorderBrush="LightBlue"
                                BorderThickness="1,0,0,0">

                    <StackPanel Orientation="Horizontal">
                        <TextBlock Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}">
                            <Run FontWeight="Bold">Votes:</Run> <Run Text="{x:Bind Comment.TotalVotes}"/> 
                            <Run FontWeight="Bold">User:</Run> <Run Text="{x:Bind Comment.UserName}"/>
                            <Run FontWeight="Bold">Date:</Run> <Run Text="{x:Bind Comment.Date, Converter={StaticResource TimeAgoConverter}}"/>
                        </TextBlock>
                    </StackPanel>

                    <TextBlock Text="{x:Bind Comment.Content}"
                               FontSize="{ThemeResource TextStyleLargeFontSize}"
                               Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                               HorizontalAlignment="Left"
                               Style="{ThemeResource BodyTextBlockStyle}"
                               IsTapEnabled="True"/>
                </StackPanel>

                <ListView SelectionMode="None"
                          IsItemClickEnabled="False"
                          ItemTemplate="{StaticResource CommentTreeTemplate}"
                          ItemContainerStyle="{StaticResource ContentTreeItemStyle}"
                          Visibility="{x:Bind HasChildren, Converter={StaticResource BoolToVisibilityConverter}}"
                          ItemsSource="{x:Bind Children}"/>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="LinkSubmissionTemplate" x:DataType="voatModels:ApiSubmission">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!--The {Binding} binds the content to the current DataContext. Same effect is not possible through x:Bind-->
                <ContentPresenter ContentTemplate="{StaticResource SubmissionHeaderTemplate}" Content="{Binding}" />

                <WebView x:Name="submissionWebView" Source="{x:Bind Url}"
                         Grid.Row="1"></WebView>
            </Grid>
        </DataTemplate>
        
        <!--Misc resourec-->
        <Flyout x:Key="NotFoundFlyout">
            <TextBlock Text="Not Found."/>
        </Flyout>
    </Page.Resources>

    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="MasterColumn" Width="400" />
            <ColumnDefinition x:Name="DetailColumn" Width="*" />
        </Grid.ColumnDefinitions>

        <Grid x:Name="MasterColumnGrid" Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <TextBlock x:Name="MasterTopBar" 
                       Margin="12,5"
                       Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}"
                       FontWeight="Bold"
                       FontSize="{ThemeResource TextStyleExtraLargeFontSize}"
                       Text="{x:Bind ViewModel.CurrentSubverse, Mode=OneWay}"
                       Style="{ThemeResource TitleTextBlockStyle}" />

            <AutoSuggestBox x:Name="MasterSearchBox" Grid.Row="1"
                            Margin="12,5"
                            QueryIcon="Find"
                            QuerySubmitted="MasterSearchBox_QuerySubmitted"
                            PlaceholderText="Search subverse..."/>

            <ProgressRing x:Name="MasterProgressRing" Grid.Row="2"
                          Margin="0,50" Width="50" Height="50"
                          Visibility="{x:Bind ViewModel.LoadingSubmissions, Converter={StaticResource BoolToVisibilityConverter}, Mode=OneWay}" 
                          IsActive="{x:Bind ViewModel.LoadingSubmissions, Mode=OneWay}"/>

            <ListView x:Name="MasterListView" Grid.Row="3"
                      ItemTemplate="{StaticResource SubmissionItemTemplate}"
                      Visibility="{x:Bind ViewModel.LoadingSubmissions, Converter={StaticResource BoolToNegateVisibilityConverter}, Mode=OneWay}"
                      IsItemClickEnabled="True"
                      ItemClick="MasterListView_ItemClick">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    </Style>
                </ListView.ItemContainerStyle>
            </ListView>

            <CommandBar x:Name="MasterCommandBar" Grid.Row="4">
                <CommandBar.Content>
                    <TextBlock Text="Sort by: Hot" Margin="12,14"/>
                </CommandBar.Content>

                <AppBarButton Icon="Back" Label="Back" Tag="Back" Click="MasterCommandBarButton_Click"/>
                <AppBarButton Icon="Sort" Label="Sort">
                    <AppBarButton.Flyout>
                        <MenuFlyout>
                            <MenuFlyoutItem Text="Hot" Tag="hot" Click="SortSubmissions_Click"/>
                            <MenuFlyoutItem Text="New" Tag="new" Click="SortSubmissions_Click"/>
                            <MenuFlyoutItem Text="Top" Tag="top" Click="SortSubmissions_Click"/>
                        </MenuFlyout>
                    </AppBarButton.Flyout>
                </AppBarButton>

                <AppBarButton Icon="Refresh" Label="Refresh" Tag="refresh" Click="MasterCommandBarButton_Click"/>

                <!--<CommandBar.SecondaryCommands>
                    <AppBarButton Icon="Like" Label="Like" Click="MasterCommandBarButton_Click"/>
                    <AppBarButton Icon="Dislike" Label="Dislike" Click="MasterCommandBarButton_Click"/>
                </CommandBar.SecondaryCommands>-->
            </CommandBar>
        </Grid>

        <Grid x:Name="DetailColumnGrid" Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <ContentPresenter
                x:Name="DetailContentPresenter"
                Grid.Row="0"
                BorderThickness="1,0,0,0"
                Padding="24,0"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}"
                DataContextChanged="DetailContentPresenter_DataContextChanged"/>

            <CommandBar x:Name="DetailCommandBar" Grid.Row="1">
                <CommandBar.Content>
                    <TextBlock Text="Some space." Margin="12,14"/>
                </CommandBar.Content>

                <AppBarButton Icon="Back" Label="Back" Tag="back" Click="DetailCommandBarButton_Click"/>
                <AppBarButton Icon="Forward" Label="Forward" Tag="forward" Click="DetailCommandBarButton_Click"/>

                <AppBarSeparator/>

                <AppBarButton Icon="Refresh" Label="Refresh" Tag="refresh" Click="DetailCommandBarButton_Click"/>
                <AppBarButton Icon="Save" Label="Save" Tag="save" Click="DetailCommandBarButton_Click"/>
                <AppBarButton Icon="ReShare"  Label="Share" Tag="share" Click="DetailCommandBarButton_Click"/>

                <!--<CommandBar.SecondaryCommands>
                    <AppBarButton Icon="Dislike" Label="Dislike" Tag="dislike" Click="DetailCommandBarButton_Click"/>
                </CommandBar.SecondaryCommands>-->
            </CommandBar>
        </Grid>
    </Grid>
</Page>
